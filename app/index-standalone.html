<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Storage Finder | Notre Dame</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
/* Data Storage Finder - Notre Dame branding */
:root {
  --nd-blue: #0c2340;
  --nd-gold: #ae9142;
  --nd-gold-light: #c4a853;
  --nd-gold-pale: #e8dbb8;
  --bg: #f5f5f5;
  --surface: #fff;
  --border: #d4d8dc;
  --text: #1a1a1a;
  --text-muted: #5a5a5a;
  --primary: var(--nd-blue);
  --primary-hover: #0a1c33;
  --radius: 8px;
  --radius-card: 10px;
  --shadow: 0 1px 4px rgba(12, 35, 64, 0.08);
  --shadow-card: 0 2px 8px rgba(12, 35, 64, 0.1);
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: var(--font); font-size: 16px; line-height: 1.5; color: var(--text); background: var(--bg); min-height: 100vh; display: flex; flex-direction: column; }
.header { background: var(--nd-blue); color: #fff; border-bottom: 3px solid var(--nd-gold); padding: 1.25rem 1.5rem 1.75rem; }
.header h1 { margin: 0 0 0.2rem; font-size: 1.65rem; font-weight: 700; letter-spacing: -0.02em; }
.tagline { margin: 0; color: rgba(255, 255, 255, 0.88); font-size: 0.95rem; }
.main { flex: 1; display: grid; grid-template-columns: 380px 1fr; gap: 0; max-width: 1400px; margin: 0 auto; width: 100%; min-height: 0; }
@media (max-width: 900px) { .main { grid-template-columns: 1fr; } }
.section-describe { margin: 0; border-radius: 0; box-shadow: none; border-right: 1px solid var(--border); padding: 1.5rem 1.5rem 2rem; background: var(--surface); overflow-y: auto; }
@media (max-width: 900px) { .section-describe { border-right: none; border-bottom: 1px solid var(--border); } }
.section-describe h2 { color: var(--nd-blue); font-size: 1.35rem; font-weight: 700; margin: 0 0 0.5rem; }
.section-describe .section-desc { font-size: 0.9rem; color: var(--text-muted); margin: 0 0 1.25rem; line-height: 1.5; }
.section-describe .actions { margin-bottom: 1.25rem; }
.btn-clear { background: var(--nd-gold); color: var(--nd-blue); border: 1px solid var(--nd-gold); font-weight: 600; }
.btn-clear:hover { background: var(--nd-gold-light); border-color: var(--nd-gold-light); color: var(--nd-blue); }
.criteria-filters { display: flex; flex-direction: column; gap: 1.25rem; }
.filter-group { max-width: 100%; }
.filter-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; color: var(--nd-blue); }
.filter-group select { width: 100%; padding: 0.55rem 0.65rem; font-size: 0.9rem; font-family: inherit; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); }
.filter-group select:focus { outline: none; border-color: var(--nd-blue); box-shadow: 0 0 0 2px rgba(12, 35, 64, 0.15); }
.section-services { margin: 0; border-radius: 0; box-shadow: none; padding: 1.5rem 1.75rem 2rem; background: var(--bg); overflow-y: auto; }
.section-services .card-header-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
.section-services h2 { display: flex; align-items: center; gap: 0.5rem; color: var(--nd-blue); font-size: 1.2rem; font-weight: 700; margin: 0; }
.section-services h2 .arrow { color: var(--nd-gold); font-size: 1.1rem; }
.section-services .section-desc { font-size: 0.9rem; color: var(--text-muted); margin: 0 0 0.5rem; }
.section-services .actions { margin: 0; }
.btn-primary { background: var(--nd-blue); color: #fff; border-color: var(--nd-blue); }
.btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); color: #fff; }
.btn-secondary { background: var(--surface); color: var(--nd-blue); border: 1px solid var(--nd-blue); }
.btn-secondary:hover { background: rgba(12, 35, 64, 0.06); color: var(--nd-blue); }
.btn-outline-gold { background: var(--surface); color: var(--nd-gold); border: 1px solid var(--nd-gold); }
.btn-outline-gold:hover { background: var(--nd-gold-pale); color: var(--nd-blue); border-color: var(--nd-gold-light); }
.services-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; margin-top: 0.5rem; }
.service-box { display: flex; flex-direction: column; align-items: stretch; padding: 0; border: 1px solid var(--border); border-radius: var(--radius-card); background: var(--surface); box-shadow: var(--shadow); cursor: pointer; transition: box-shadow 0.2s, border-color 0.2s, opacity 0.2s; position: relative; min-height: 100px; text-align: left; }
.service-box.matches { opacity: 1; border-color: var(--border); }
.service-box.matches:hover { box-shadow: var(--shadow-card); border-color: var(--nd-blue); }
.service-box.no-match { opacity: 0.55; background: #f0f0f0; border-color: #e0e0e0; }
.service-box.no-match:hover { opacity: 0.75; }
.service-box.selected { border-color: var(--nd-blue); box-shadow: 0 0 0 2px rgba(12, 35, 64, 0.2); }
.service-box.selected .service-box-select { background: var(--nd-blue); border-color: var(--nd-blue); }
.service-box.selected .service-box-select::after { display: none; }
.service-box.no-match.selected { opacity: 1; }
.service-box-inner { padding: 1rem 1rem 1rem 1rem; padding-right: 2.75rem; }
.service-box-select { position: absolute; top: 0.85rem; right: 0.85rem; width: 22px; height: 22px; border: 2px solid var(--nd-blue); border-radius: 50%; background: transparent; flex-shrink: 0; transition: background 0.15s, border-color 0.15s; }
.service-box-select::after { content: ''; position: absolute; inset: 3px; border-radius: 50%; background: #fff; opacity: 0; }
.service-box input { position: absolute; opacity: 0; pointer-events: none; }
.service-box-name { font-weight: 700; font-size: 0.95rem; color: var(--nd-blue); margin: 0 0 0.35rem; line-height: 1.3; }
.service-box-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; margin: 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.service-box-desc.empty { display: none; }
.match-count { margin: 1rem 0 0; font-size: 0.9rem; color: var(--text-muted); }
.section-compare { grid-column: 1 / -1; max-width: 1400px; margin: 1.5rem auto 1.5rem; width: calc(100% - 3rem); border-radius: var(--radius); box-shadow: var(--shadow); }
.section-compare h2 { color: var(--nd-blue); font-size: 1.25rem; font-weight: 700; }
.compare-table th { background: var(--nd-blue); color: #fff; font-weight: 600; }
.compare-table tr:nth-child(even) td { background: #f8f9fa; }
.card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.25rem 1.5rem; }
.card h2 { margin: 0 0 0.35rem; font-size: 1.25rem; font-weight: 600; }
.section-desc { margin: 0 0 1rem; color: var(--text-muted); font-size: 0.95rem; }
.actions { margin-bottom: 1rem; }
.btn { display: inline-block; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: 500; font-family: inherit; border-radius: 6px; border: 1px solid transparent; cursor: pointer; text-decoration: none; margin-right: 0.5rem; margin-bottom: 0.5rem; }
.compare-table-wrap { margin-top: 1rem; }
.table-scroll { overflow-x: auto; margin-bottom: 1rem; }
.compare-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
.compare-table th, .compare-table td { padding: 0.5rem 0.75rem; text-align: left; border: 1px solid var(--border); vertical-align: top; }
.loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 1rem 1.5rem; background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-card); font-size: 1rem; color: var(--nd-blue); border: 1px solid var(--border); }
.error { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); max-width: 90%; padding: 1rem 1.5rem; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: var(--radius); font-size: 0.95rem; }
.hidden { display: none !important; }
.footer { padding: 1rem 1.5rem; text-align: center; font-size: 0.85rem; color: var(--text-muted); border-top: 1px solid var(--border); background: var(--nd-blue); color: rgba(255, 255, 255, 0.85); }
.footer p { margin: 0; }
  </style>
</head>
<body>
  <header class="header">
    <h1>Data Storage Finder</h1>
    <p class="tagline">Find and compare data storage options that match your needs.</p>
  </header>

  <main class="main">
    <section id="data-section" class="card section-describe">
      <h2>Describe your data</h2>
      <p class="section-desc">Answer these questions to help identify data storage services that are suitable for your needs. Your answers will highlight matching services and grey out others. If you are uncertain how to answer, leave the question blank to see all options.</p>
      <div class="actions">
        <button type="button" class="btn btn-clear" id="clear-filters">Clear answers</button>
      </div>
      <div id="criteria-filters" class="criteria-filters"></div>
    </section>

    <section id="services-section" class="card section-services">
      <div class="card-header-row">
        <div>
          <h2><span class="arrow" aria-hidden="true">→</span> Select data storage services you would like to compare.</h2>
          <p class="section-desc">Click anywhere on a card to add or remove it from your comparison.</p>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-secondary" id="select-all">Select all</button>
          <button type="button" class="btn btn-outline-gold" id="clear-selection">Clear selections</button>
        </div>
      </div>
      <div id="services-list" class="services-list"></div>
      <p class="match-count"><span id="match-count">0 of 0</span> service(s) match your criteria.</p>
    </section>

    <section id="compare-section" class="card section-compare">
      <h2>Compare results</h2>
      <p class="section-desc">Compare the services you selected.</p>
      <div id="compare-table-wrap" class="compare-table-wrap hidden">
        <div class="table-scroll">
          <table id="compare-table" class="compare-table"></table>
        </div>
      </div>
    </section>
  </main>

  <div id="loading" class="loading">Loading data…</div>
  <div id="error" class="error hidden"></div>

  <footer class="footer">
    <p>Content is derived from the Data Storage Matrix. We welcome feedback.</p>
  </footer>

  <script>
(function () {
  'use strict';

  const DATA_JSON = 'data/services.json';
  const DATA_XLSX = 'Data_Storage_Matrix.xlsx';

  let state = {
    criteria: [],
    services: [],
    questions: [],
    nameKey: null,
    filterValues: {},
    selectedIds: new Set(),
  };

  function showLoading(show) {
    const el = document.getElementById('loading');
    if (el) el.classList.toggle('hidden', !show);
  }

  function showError(msg) {
    const el = document.getElementById('error');
    if (el) {
      el.textContent = msg;
      el.classList.remove('hidden');
    }
  }

  function hideError() {
    const el = document.getElementById('error');
    if (el) el.classList.add('hidden');
  }

  function parseSheetToData(rows) {
    if (!rows || rows.length < 2) return null;
    const headers = rows[0].map((h) => (h != null && h !== '' ? String(h).trim() : ''));
    const nameKey =
      headers.find((h) => String(h || '').trim().toLowerCase() === 'service') ||
      headers[0] ||
      'Service';
    const criteria = headers
      .filter((h) => h && h !== nameKey)
      .map((h) => ({ id: slug(h), label: h }));
    const services = [];
    for (let r = 1; r < rows.length; r++) {
      const row = rows[r];
      if (!row.some((c) => c !== '' && c != null)) continue;
      const obj = {};
      headers.forEach((h, i) => {
        const key = h || 'Column_' + i;
        obj[key] = row[i] == null || row[i] === '' ? '' : String(row[i]).trim();
      });
      services.push(obj);
    }
    return { nameKey, criteria, services };
  }

  function parseQuestionsSheet(rows, criteria, services) {
    if (!rows || rows.length < 2 || !criteria.length) return [];
    const headers = (rows[0] || []).map((h) => (h != null ? String(h).trim() : ''));
    const questionCol = headers.findIndex((h) => /question/i.test(h || ''));
    const optionsCol = headers.findIndex((h) => /option/i.test(h || ''));
    if (questionCol < 0 || optionsCol < 0) return [];
    const optionValuesByColumn = {};
    criteria.forEach((c) => {
      const set = new Set();
      services.forEach((s) => {
        const v = (s[c.label] || '').trim();
        if (v) set.add(v.trim().toLowerCase());
      });
      optionValuesByColumn[c.label] = set;
    });
    const questions = [];
    for (let r = 1; r < rows.length; r++) {
      const row = rows[r];
      const questionText = (row[questionCol] ?? '').toString().trim();
      if (!questionText) continue;
      const optionsRaw = (row[optionsCol] ?? '').toString();
      const options = optionsRaw
        .split(/\r?\n/)
        .map((o) => o.trim())
        .filter(Boolean);
      if (!options.length) continue;
      const qId = slug(questionText) || 'q' + r;
      let bestColumn = null;
      let bestScore = 0;
      const qOptSet = new Set(options.map((o) => o.toLowerCase()));
      criteria.forEach((c) => {
        const colSet = optionValuesByColumn[c.label];
        let score = 0;
        qOptSet.forEach((opt) => {
          if (colSet.has(opt)) score++;
        });
        if (score > bestScore) {
          bestScore = score;
          bestColumn = c.label;
        }
      });
      questions.push({
        id: qId,
        label: questionText,
        options: options,
        column: bestColumn || criteria[questions.length]?.label || null,
      });
    }
    return questions;
  }

  function slug(s) {
    return String(s || '')
      .trim()
      .replace(/\s+/g, '_')
      .replace(/[^a-zA-Z0-9_]/g, '')
      .toLowerCase() || 'col';
  }

  function getServiceId(svc) {
    return (svc[state.nameKey] || '').trim() || JSON.stringify(svc);
  }

  function loadFromJSON() {
    return fetch(DATA_JSON)
      .then((r) => (r.ok ? r.json() : Promise.reject(new Error('Not found'))))
      .then((data) => {
        if (!data.services) throw new Error('Invalid data format');
        state.criteria = data.criteria || [];
        state.services = data.services;
        state.questions = data.questions || [];
        state.nameKey =
          data.nameKey ||
          (state.services[0] ? Object.keys(state.services[0]).find((k) => /service/i.test(k)) : null) ||
          (state.services[0] ? Object.keys(state.services[0])[0] : null) ||
          'Service';
      });
  }

  function loadFromXLSX() {
    return fetch(DATA_XLSX)
      .then((r) => (r.ok ? r.arrayBuffer() : Promise.reject(new Error('Not found'))))
      .then((buf) => {
        if (typeof XLSX === 'undefined') throw new Error('SheetJS not loaded');
        const wb = XLSX.read(buf, { type: 'array' });
        const matrixName = wb.SheetNames.find((n) => /matrix|data storage/i.test(n)) || wb.SheetNames[0];
        const ws = wb.Sheets[matrixName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        const data = parseSheetToData(rows);
        if (!data) throw new Error('Excel has no data');
        state.nameKey = data.nameKey;
        state.criteria = data.criteria;
        state.services = data.services;
        const qName = wb.SheetNames.find((n) => /^questions$/i.test((n || '').trim()));
        if (qName) {
          const qRows = XLSX.utils.sheet_to_json(wb.Sheets[qName], { header: 1, defval: '' });
          state.questions = parseQuestionsSheet(qRows, state.criteria, state.services);
        } else {
          state.questions = [];
        }
      });
  }

  function loadData() {
    showLoading(true);
    hideError();
    loadFromJSON()
      .then(() => {
        if (!state.services.length) return loadFromXLSX();
      })
      .catch(() => loadFromXLSX())
      .then(() => {
        state.filterValues = {};
        state.selectedIds = new Set();
        renderCriteriaFilters();
        renderServicesList();
        updateCompareSection();
      })
      .catch((err) => {
        showError(
          'Could not load data. Add data/services.json (run: npm run build-data) or place Data_Storage_Matrix.xlsx in the app folder. ' +
            (err.message || '')
        );
      })
      .finally(() => showLoading(false));
  }

  function getUniqueValues(key) {
    const set = new Set();
    state.services.forEach((s) => {
      const v = (s[key] || '').trim();
      if (v) set.add(v);
    });
    return Array.from(set).sort();
  }

  function getFilterSources() {
    return state.questions.length
      ? state.questions.filter((q) => q.column)
      : state.criteria.map((c) => ({ id: c.id, label: c.label, options: getUniqueValues(c.label), column: c.label }));
  }

  function renderCriteriaFilters() {
    const wrap = document.getElementById('criteria-filters');
    wrap.innerHTML = '';
    const sources = getFilterSources();
    sources.forEach((src) => {
      const columnKey = src.column || src.label;
      const anyLabel = '— Any —';
      const options = src.options ? [anyLabel, ...src.options] : [anyLabel, ...getUniqueValues(columnKey)];
      const div = document.createElement('div');
      div.className = 'filter-group';
      const label = document.createElement('label');
      label.textContent = src.label;
      const select = document.createElement('select');
      select.dataset.column = columnKey;
      options.forEach((opt) => {
        const o = document.createElement('option');
        o.value = opt === anyLabel ? '' : opt;
        o.textContent = opt;
        select.appendChild(o);
      });
      select.addEventListener('change', () => {
        state.filterValues[columnKey] = select.value;
        renderServicesList();
        updateCompareSection();
      });
      div.appendChild(label);
      div.appendChild(select);
      wrap.appendChild(div);
    });
  }

  function matchesFilters(service) {
    const sources = getFilterSources();
    for (const src of sources) {
      const columnKey = src.column || src.label;
      const chosen = state.filterValues[columnKey];
      if (!chosen) continue;
      const raw = (service[columnKey] || '').trim();
      const cellValues = raw.split(/[,;]/).map((s) => s.trim()).filter(Boolean);
      const exactMatch = raw === chosen;
      const listMatch = cellValues.length > 0 && cellValues.some((v) => v === chosen);
      if (!exactMatch && !listMatch) return false;
    }
    return true;
  }

  function getFilteredServices() {
    return state.services.filter((s) => matchesFilters(s));
  }

  function getServiceDescription(svc) {
    const descKey = state.services[0] && Object.keys(state.services[0]).find((k) => /description/i.test(k));
    if (!descKey) return '';
    const raw = (svc[descKey] || '').trim();
    if (!raw) return '';
    const firstLine = raw.split(/\r?\n/)[0].trim();
    return firstLine.length > 140 ? firstLine.slice(0, 137) + '…' : firstLine;
  }

  function renderServicesList() {
    const list = document.getElementById('services-list');
    const countEl = document.getElementById('match-count');
    const filtered = getFilteredServices();
    if (countEl) countEl.textContent = filtered.length + ' of ' + state.services.length;

    list.innerHTML = '';
    state.services.forEach((svc) => {
      const name = (svc[state.nameKey] || '').trim() || 'Unnamed';
      const desc = getServiceDescription(svc);
      const id = getServiceId(svc);
      const matches = matchesFilters(svc);
      const box = document.createElement('label');
      box.className =
        'service-box ' +
        (matches ? 'matches' : 'no-match') +
        (state.selectedIds.has(id) ? ' selected' : '');
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = state.selectedIds.has(id);
      input.addEventListener('change', (e) => {
        e.stopPropagation();
        if (input.checked) state.selectedIds.add(id);
        else state.selectedIds.delete(id);
        box.classList.toggle('selected', input.checked);
        updateCompareSection();
      });
      box.addEventListener('click', (e) => {
        if (e.target === input || e.target === selectDiv) return;
        input.checked = !input.checked;
        if (input.checked) state.selectedIds.add(id);
        else state.selectedIds.delete(id);
        box.classList.toggle('selected', input.checked);
        updateCompareSection();
      });
      const selectDiv = document.createElement('span');
      selectDiv.className = 'service-box-select';
      selectDiv.setAttribute('aria-hidden', 'true');
      const inner = document.createElement('div');
      inner.className = 'service-box-inner';
      const nameEl = document.createElement('div');
      nameEl.className = 'service-box-name';
      nameEl.textContent = name;
      const descEl = document.createElement('p');
      descEl.className = 'service-box-desc' + (desc ? '' : ' empty');
      descEl.textContent = desc || '';
      box.appendChild(input);
      box.appendChild(selectDiv);
      inner.appendChild(nameEl);
      inner.appendChild(descEl);
      box.appendChild(inner);
      list.appendChild(box);
    });
  }

  function updateCompareSection() {
    const wrap = document.getElementById('compare-table-wrap');
    const table = document.getElementById('compare-table');
    if (!wrap || !table) return;
    const selected = state.services.filter((s) => state.selectedIds.has(getServiceId(s)));
    if (selected.length === 0) {
      wrap.classList.add('hidden');
      return;
    }
    wrap.classList.remove('hidden');
    buildCompareTable(table, selected);
  }

  function buildCompareTable(table, selected) {
    table.innerHTML = '';
    const headers = [state.nameKey, ...state.criteria.map((c) => c.label)];
    const thead = document.createElement('thead');
    const trHead = document.createElement('tr');
    headers.forEach((h) => {
      const th = document.createElement('th');
      th.textContent = h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    selected.forEach((svc) => {
      const tr = document.createElement('tr');
      headers.forEach((key) => {
        const td = document.createElement('td');
        td.textContent = (svc[key] || '').trim() || '—';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
  }

  document.getElementById('clear-filters')?.addEventListener('click', () => {
    state.filterValues = {};
    document.querySelectorAll('#criteria-filters select').forEach((s) => {
      s.value = s.options[0]?.value ?? '';
    });
    renderServicesList();
    updateCompareSection();
  });

  document.getElementById('select-all')?.addEventListener('click', () => {
    getFilteredServices().forEach((s) => state.selectedIds.add(getServiceId(s)));
    renderServicesList();
    updateCompareSection();
  });

  document.getElementById('clear-selection')?.addEventListener('click', () => {
    state.selectedIds.clear();
    renderServicesList();
    updateCompareSection();
  });

  loadData();
})();
  </script>
</body>
</html>
